import React, {useEffect, useRef, useState} from 'react';
import {citiesAPI} from 'api/apiAxios'

import s from './Form.module.scss';

export const Form = ({citiesListProps}) => {
    let disabledToggle = !citiesListProps.length;
    let selectRefCity = useRef();
    let selectRefDay = useRef();
    let selectRefTime = useRef();

    const [userPhone, setUserPhone] = useState('');
    const [userName, setUserName] = useState('')
    const [cityData, setCityData] = useState({
        "id": "5b3480ee3200009f28d1e421",
        "name": "Владивосток",
        "address": "ул. Первая 1, ст. 3",
        "phones": ["79991233232", "79996667676"],
        "price": 12000
    })
    const [vacantTime, setVacantTime] = useState([])
    const [data_and_time, setData_and_time] = useState()

    let days = [];
    let time = [];

    for (let prop1 in data_and_time) {
        for (let prop2 in data_and_time[prop1]) {
            if (data_and_time[prop1][prop2].is_not_free !== true) {
                days.push(data_and_time[prop1][prop2].day)
                time.push(data_and_time[prop1][prop2])
            }
        }
        ;
    }

    let setCity = () => {
        setCityData(citiesListProps.find(city => city.name === selectRefCity.current.value))
    }
    let setVacantTimeByDay = () => {
        setVacantTime(time.filter(d => d.day === selectRefDay.current.value))
    }
    useEffect(() => {
        citiesAPI.getDataByID(cityData.id).then(data => setData_and_time(data.data))
    }, [cityData]);

    let vacantDaysList = Array.from(new Set(days));

    const saveUserData = (e) => {
        e.preventDefault()
        localStorage.setItem("заявка",
            JSON.stringify({
                город: selectRefCity.current.value,
                день: selectRefDay.current.value,
                время: selectRefTime.current.value,
                имя: userName,
                телефон: userPhone,
            })
        )
        setUserName('')
        setUserPhone('')
        selectRefDay.current.value = '';
        selectRefTime.current.value = '';
    }


    return (
        <>
            <form onSubmit={saveUserData}
                  className=
                      {!citiesListProps.length ? s.mainWrapper + " " + s.opacityOn : s.mainWrapper}>
                <select
                    disabled={disabledToggle}
                    className={s.inputItem}
                    ref={selectRefCity} onChange={setCity}
                >
                    {citiesListProps.map(c => <option value={c.name} key={c.id}>{c.name}</option>)}
                </select>

                <div className={s.cityData}>
                    <p>{cityData.address}</p>
                    <p>{cityData.phones.join(', ')}</p>
                    <p>{`Стоимость услуги ${cityData.price}`}</p>
                </div>

                <div className={s.data_and_time}>
                    <select ref={selectRefDay} onChange={setVacantTimeByDay} disabled={disabledToggle}
                            className={s.inputItem} name="pets" id="pet-select">
                        <option value="">День</option>
                        {vacantDaysList.map(d => <option key={d} value={d}>{d}</option>)}
                    </select>

                    <select disabled={disabledToggle} ref={selectRefTime} className={s.inputItem} name="pets"
                            id="pet-select">
                        <option value="">Время</option>
                        {vacantTime.map(h => <option>{h.begin}-{h.end}</option>)}
                    </select>
                </div>

                <input disabled={disabledToggle}
                       value={userPhone} onChange={(e) => setUserPhone(e.currentTarget.value)}
                       className={s.inputItem} type="text" placeholder='+7(___)__ __'/>

                <input disabled={disabledToggle} onChange={(e) => setUserName(e.currentTarget.value)}
                       value={userName} className={s.inputItem} type="text" placeholder='Ваше имя'/>


            </form>
            <button onClick={saveUserData} disabled={disabledToggle} className={s.button}>Записаться</button>
        </>
    );
}
